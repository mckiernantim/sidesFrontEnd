<main class="last-looks-container">
    <div class="page shadow-lg border" (click)="showContextMenu && closeContextMenu()">
        <div class="break">
            <ul class="screenbox" [ngClass]="{ 'edit-mode': canEditDocument }">
                <!-- [attr.contenteditable]="canEditDocument ? 'true' : 'false'" this line will activate easy edit - -->

                <ng-container *ngFor="let line of page; let lineIndex = index">
                    <span class="watermark">{{ line.watermarkText }}</span>
                    <span class="draft-text">{{ line.draftText }}</span>

                    <!-- page number span -->
                    <span class="draft-color-text true">
                        {{ line.draftColorText }}
                    </span>
                    <span class="page-number-text {{ line.hidden }}"
                        (blur)="onLineChange(line, lineIndex, $event.target.textContent, 'pageNumberText')">
                        {{ line.pageNumberText }} {{ line.hidden }}
                    </span>

                    <!-- scene number span -->
                    <span *ngIf="line.category === 'scene-header'"
                        [class]="'scene-number-left ' + line.trueScene + ' ' + line.visible"
                        (blur)="onLineChange(line, lineIndex, $event.target.textContent, 'sceneNumberText')"
                        [style.bottom]="line.calculatedYpos" [style.left]="line.calculatedXpos">
                        {{ line.sceneNumberText }}
                    </span>

                    <!-- Always rendered span with text and style -->
                    <span *ngIf="line.category !== 'page-number' && line.category !== 'page-number-hidden' && line.category !== 'injected-break'"
                        [attr.data-line-id]="line.id" [class]="(line.bar ? line.bar : 'hideBar')"
                        [style.bottom]="line.calculatedYpos">
                        <!-- Removed cdkDrag functionality -->
                        <span class="start-span">START {{ line.sceneNumberText }}</span>
                    </span>

                    <!-- Conditionally render li element with drag functionality -->
                    <ng-container *ngIf="canEditDocument; else nonEditable">
                        <li id="{{ line.index }}" 
                            cdkDrag
                            [cdkDragDisabled]="!canEditDocument"
                            (cdkDragStarted)="onDragStarted($event, line)"
                            (cdkDragMoved)="onDragMoved($event, line)"
                            (cdkDragEnded)="onDragEnded($event, line, lineIndex)"
                            [value]="line.sceneNumber"
                            [class]="line.category + ' ' + line.visible + ' ' + line.hidden"
                            [class.selected-line]="isLineSelected(line)"
                            [class.multi-selected]="selectedLineIds.length > 1 && isLineSelected(line)"
                            [class.editing]="editingLine === lineIndex"
                            [class.crossed-out]="line.crossedOut"
                            [ngClass]="{ 'edit-li': canEditDocument }"
                            (click)="selectLine(line, $event)"
                            (dblclick)="onDoubleClick(lineIndex, line.text)"
                            [style.bottom]="line.calculatedYpos" 
                            [style.left]="line.calculatedXpos"
                            [attr.contenteditable]="editingLine === lineIndex ? 'true' : 'false'"
                            [style.background-color]="editingLine === lineIndex ? 'orange' : 'transparent'"
                            (blur)="editingLine === lineIndex && saveEdit()"
                            (keydown)="handleKeyDown($event, line, lineIndex)"
                            (input)="editingLine === lineIndex && onEditTextChange($event.target.textContent)"
                            [textContent]="line.text"
                            (contextmenu)="canEditDocument && openContextMenu($event, line, lineIndex)">
                        </li>
                    </ng-container>
                    <ng-template #nonEditable>
                        <li id="{{ line.index }}" 
                            [value]="line.sceneNumber"
                            [class]="line.category + ' ' + line.visible + ' ' + line.hidden"
                            [class.selected-line]="isSelectedLine(line, lineIndex)"
                            [style.bottom]="line.calculatedYpos"
                            [style.left]="line.calculatedXpos" 
                            [textContent]="line.text">
                        </li>
                    </ng-template>

                    <!-- revision asterisks -->
                    <span [class]="line.isRevision + ' hidden'" [style.bottom]="line.calculatedYpos">
                        *
                    </span>

                    <!-- continue spans -->
                    <span class="bar-span continue-span" [attr.data-line-id]="line.id"
                        [class]="(line.cont ? line.cont : 'hideCont') + ' ' + line.hidden"
                        [style.bottom]="line.calculatedBarY">
                        ↓↓↓ {{ line.sceneNumberText }} CONTINUED ↓↓↓
                    </span>

                    <!-- end span -->
                    <span class="bar-span end-span" [attr.data-line-id]="line.id"
                        [class]="(line.end === 'END' ? 'END' : 'hideEnd') + ' ' + line.hidden"
                        [style.bottom]="line.calculatedEnd">
                        <span class="end-span" [class.draggable-end]="canEditDocument"> 
                            END {{ line.sceneNumberText }} 
                        </span>
                    </span>

                    <!-- right scene number span -->
                    <span *ngIf="line.category === 'scene-header'"
                        class="scene-number-right {{ line.trueScene }} {{ line.visible }}"
                        [style.bottom]="line.calculatedYpos" [style.right]="line.calculatedXPos">
                        {{ line.sceneNumberText }}
                    </span>
                </ng-container>
            </ul>
            <li class="footer">made by Sides-Ways</li>
        </div>
    </div>

    <!-- Enhanced context menu with category presets -->
    <div *ngIf="showContextMenu" class="context-menu" [style.left.px]="contextMenuPosition.x" [style.top.px]="contextMenuPosition.y">
        <ul>
            <li *ngFor="let choice of categoryPresets" 
                (click)="changeLineCategory($event, choice.category, choice.xPos, selectedLine, selectedLineIndex)"
                class="classification-option">
                {{ choice.label }}
            </li>
            <li (click)="changeLineCategory($event, 'hidden', '', selectedLine, selectedLineIndex)" 
                class="classification-option text-red-500">
                Delete
            </li>
        </ul>
    </div>

    <!-- Add a click handler to the page container to clear selection when clicking outside -->
    <div class="page-background" (click)="clearSelection()">
        <!-- Your existing page content -->
    </div>
</main>
